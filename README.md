# Тестовое задание для отбора на стажировку в компанию РЕЛЭКС. Направление — Backend Java.

## Обзор

**RESTfull API-сервис**, который позволяет владельцу фермы полностью автоматизировать ее работу.
В ходе работы были
реализованы все основные и дополнительные требования.


## Стек

`Java 17`, `Gradle`, `Spring`, `Hibernate`, `PosgtreSQL`,  `Liquibase`,  `JWT`, `MapStruct`,
`QueryDsl`, `Lombok`, `TestContainers`, `Swagger`, `Docker`


## Реализованый функционал

### Владелец

- Регистрация сотрудников в системе
- Увольнение сотрудников в системе
- Регистрация новых единиц измерения в системе
- Регистрация новых типов продуктов в системе
- Получение статистического отчета по произведенным
  товарам (за любой промежуток) по конкретному сотруднику
  или ферме в целом
- Добавление рабочей нормы для сотрудника по сбору конкретного товара для текущего дня
- Получение аналитического отчета по выполненным нормам (за любой промежуток)
  по конкретному товару и/или сотруднику или ферме в целом
- Получение ежедневного статистического отчета на почту по собранным за текущий день
  товарам на ферме
- Получение ежедневного аналитического отчета на почту по выполненным нормам за текущий день
- Получение ежедневного рейтингового отчета по эффективности работы всех активных сотрудников

### Сотрудник

- Вход в систему
- Производство нового продукта для поставленной рабочей нормы
- Просмотр всех действующих/выполненных/просроченных рабочих норм за любой промежуток времени
- Получение ежедневного рейтингового отчета на почту с оценкой, рассчитываемой на основании
  выполненных/невыполненных норм

## База данных

В качестве базы данных в приложении используется Postgres. ER-диаграмма изображена на рисунке:
<img src="images/database.png" alt="database"/>

## REST API

В качестве API были реализованы следующие методы, которые изображены на рисунке:
<img src="images/endpoints.jpeg" alt="api"/>

**Эндпоинт:** `/api/v1/auth/login`

**Http метод:** `POST`

Ауентификация пользователя. Пример запроса:

```
{
    "email": "andreyantonov2702@gmail.com",
    "password": 12345
}
```

Пример ответа:

```
{
    "id": 1,
    "email": "andreyantonov2702@gmail.com",
    "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJhbmRyZXlhbnRvbm92MjcwMkBnbWFpbC5jb20iLCJpZCI6MSwicm9sZSI6IlJPTEVfT1dORVIiLCJleHAiOjE3MTA0OTE4OTd9.K7-mp5OvPHvhG_DzPALuqonNOx5LPtyo-pDqiiDVnCeNXh8cfCObyWnkfdDf7kshF4E9R3mNPwmgrmjCb9rCHQ"
}
```

---
**Эндпоинт:** `/api/v1/auth/registation`

**Http метод:** `POST`

Регистрация пользователя. Пример запроса:

```
{
    "firstName": "Andrey",
    "middleName": "Antonov",
    "lastName": "Andreevich",
    "email": "test1@email.com",
    "password": "12345"
}
```

Пример ответа:

```
{
    "id": 2,
    "email": "test1@email.com",
    "enabled": true,
    "role": "ROLE_EMPLOYEE"
}
```

---
**Эндпоинт:** `/api/v1/units`

**Http метод:** `GET`

Получение всех единиц измерения. Пример ответа:

```
[
    {
        "id": 1,
        "name": "кг"
    },
    {
        "id": 2,
        "name": "шт"
    },
    {
        "id": 3,
        "name": "л"
    }
]
```

---
**Эндпоинт:** `/api/v1/units`

**Http метод:** `POST`

Добавление новой единицы измерения в систему. Пример запроса:

```
{
    "name": "килограмм"
}
```

Пример ответа

```
{
    "id": 4,
    "name": "килограмм"
}
```

---
**Эндпоинт:** `/api/v1/products`

**Http метод:** `GET`

Получение всех зарегистрированных продуктов. Пример ответа:

```
[
    {
        "id": 1,
        "name": "Яйки куриные",
        "unit": "шт"
    },
    {
        "id": 2,
        "name": "Яблоки",
        "unit": "шт"
    },
    {
        "id": 3,
        "name": "Молоко",
        "unit": "л"
    }
]
```

---
**Эндпоинт:** `/api/v1/products`

**Http метод:** `POST`

Регистрация нового продукта в системе. Пример запроса:

```
{
    "name": "Сочная ягодка",
    "unit": "кг"
}
```

Пример ответа:

```
{
    "id": 4,
    "name": "Сочная ягодка",
    "unit": "кг"
}
```

---
**Эндпоинт:** `/api/v1/working-norms`

**Http метод:** `POST`

Добавление рабочей нормы. Пример запроса:

```
{
    "employeeId": 2,
    "productId": 3,
    "workingCount": 10,
    "deadline": "2024-03-15 12:00"
}
```

Пример ответа:

```
{
    "id": 1,
    "productId": 3,
    "employeeId": 2,
    "workingCount": 10,
    "currentCount": 0,
    "deadline": "2024-03-15 12:00",
    "status": "IN_PROGRESS"
}
```

---
**Эндпоинт:** `/api/v1/employees/{id}/products`

**Http метод:** `POST`

Производство продукта. Пример запроса:

```
{
    "productId": 3,
    "count": 5
}
```

Пример ответа:

```
{
    "id": 1,
    "productId": 3,
    "employeeId": 2,
    "workingCount": 10,
    "currentCount": 5,
    "deadline": "2024-03-15 12:00",
    "status": "IN_PROGRESS"
}
```

---
**Эндпоинт:** `/api/v1/employees/{id}/working-norms`

**Http метод:** `GET`

Просмотр выданных норм. Пример параметров запроса:

- `startTime: 2024-03-15 06:00`
- `endTime: 2024-03-15 18:00`
- `status: IN_PROGRESS`

Пример ответа:

```
[
    {
        "id": 1,
        "productId": 3,
        "employeeId": 2,
        "workingCount": 10,
        "currentCount": 5,
        "deadline": "2024-03-15 12:00",
        "status": "IN_PROGRESS"
    }
]
```

---
**Эндпоинт:** `/api/v1/products/report`

**Http метод:** `GET`

Получение отчета. Пример параметров запроса (фильтрация возможна и по employeeId/productId):

- `startTime: 2024-03-15 06:00`
- `endTime: 2024-03-15 18:00`
  
Пример ответа:
```
[
    {
        "id": 3,
        "name": "Молоко",
        "unit": "л",
        "count": 5
    }
]
```

---
**Эндпоинт:** `/api/v1/working-norms/analytics`

**Http метод:** `GET`

Получение аналитического отчета. Пример параметров запроса (фильтрация возможна и по employeeId/productId):

- `startTime: 2024-03-15 06:00`
- `endTime: 2024-03-15 18:00`

Пример ответа:
```
[
    {
        "employeeId": 2,
        "productId": 3,
        "totalWorkingNorm": 10,
        "totalCurrentNorm": 5,
        "totalScore": 50.0
    }
]
```

---
**Эндпоинт:** `/api/v1/users/{employeeId}`

**Http метод:** `PUT`

Увольнение сотрудника. Пример ответа:

```
{
    "id": 2,
    "email": "test1@email.com",
    "enabled": false,
    "role": "ROLE_EMPLOYEE"
}
```

## Отправка Email
### Пример получения ежедневного статистического отчета по произведенным товарам на почту:

| product | name     | unit | total count | 
|---------|----------|------|-------------| 
| 2       | Яблоки   | шт   | 24          |
| 3       | Молоко   | л    | 21          |
| 4       | Говядина | кг   | 12          |

### Пример получения ежедневного аналитического отчета на почту:

| user | product | workingCount | currentCount | efficiency(%) |
|------|---------|--------------|--------------|---------------| 
| 2    | 2       | 20           | 13           | 65.0          |
| 2    | 3       | 10           | 10           | 100.0         |
| 2    | 4       | 10           | 7            | 70.0          |
| 3    | 2       | 10           | 11           | 110.0         |
| 3    | 3       | 15           | 11           | 73.33         |
| 3    | 4       | 10           | 5            | 50.0          |

### Пример получения ежедневного рейтингового отчета на почту:

| user | efficiency(%) |
|------|---------------| 
| 2    | 78.3          |
| 3    | 77.7          |

## Обработка ошибок

В случае возникновения ошибок пользователь получает соответствующий ответ в формате JSON
с понятным текстом ошибки. Обработаны различные сценарии ошибок для обеспечения более
надежного использования приложения.
Все исключения в системе обрабатываются и выводятся в виде:

```
{
    "message": "message",
    "errors": "errors"
}
```


### При входе в систему указаны невалидные данные

Пример запроса:

```
{
    "email": "dummy123",
    "password": 1
}
```

Пример ответа:

```
{
    "message": "Произошла ошибка при проверке введенных данных! Проверьте введенные данные и повторите попытку.",
    "errors": {
        "password": "Пароль должен содержать от 5 до 32 символов",
        "email": "Неправильный формат электронного адреса"
    }
}
```

### При добавлении продукта указан несуществующий продукт

Пример запроса:

```
{
    "productId": 10,
    "count": 5
}
```

Пример ответа:

```
{
    "message": "Продукт не найден",
    "errors": null
}
```

---

### Попытка удалить собственный аккаунт

Пример ответа:

```
{
    "message": "Нельзя удалить собственный аккаунт",
    "errors": null
}
```

# Запуск

Для успешного запуска этого проекта необходимо выполнить следующие шаги:

1. **Клонирование репозитория:**
    ```
    git https://github.com/antonov-aa2702/relex-farm-manager
    ```

2. **Сборка Jar с использованием Gradle:**
    ```
    ./gradlew bootJar
    ```

3. **Запуск приложения:**
    ```
    docker-compose up -d
    ```
3. **Приложение доступно по адресу:**
    ```
    http://localhost:8080/swagger-ui/index.html  

## Прочее
### Учетные данные для владельца фермы

- **Email**: `andreyantonov2702@gmail.com`
- **Password**: `12345`

### Информация о работе системы
- Крайне допустимое время для создания рабочей нормы: 16:59 
- Отчеты приходят ежедневно 19:00
- Планировщик задач запускает задачу обновления статусов у рабочих норм ежеминутно

## Связь

- **Email**: andrejantonov63@gmail.com
- **Telegram**: [a_antonov](https://t.me/andrej27022)
- **Вк:** [Андрей Антонов](https://vk.com/id210504883)